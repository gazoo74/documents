%% my-first-homemade-linux-distro.tex
%% Copyright 2015 Gaël PORTAY <gael.portay@gmail.com>
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Gaël PORTAY.
%
% This work consists of the file my-first-homemade-linux-distro.tex.

\documentclass[a4paper]{article}
\usepackage{caption}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{subcaption}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[francais]{babel}

\lstloadlanguages{[ANSI]C,sh,make}

\title{Ma première distribution Linux faite maison}
\author{Gaël PORTAY}
\date{\today}

\begin{document}
\sloppy
\maketitle

\begin{abstract}
\end{abstract}

\clearpage
\tableofcontents

\clearpage
\part{Le Kernel}

\section{Ma première compilation}

\begin{figure}
\label{makefile:linux_download}
\lstset{language=make,numbers=left,tabsize=2}
\begin{lstlisting}
kernel_download linux_download:
	wget -qO- https://www.kernel.org/index.html\
		| sed -n '/<td id="latest_link"/,/<\/td>/s,.*<a.*href="\(.*\)">\(.*\)</a>.*,wget -qO- \1\
		| tar xvJ \&\& ln -sf linux-\2 linux,p'\$
		| sh
\end{lstlisting}
\caption{Makefile : règle toute faite pour télécharger et extraire la dernière version stable du noyau Linux.}
\end{figure}

Entrons directement dans le vif du sujet et attaquons par la compilation du noyau !\\

\underline{Remarque} : je n'aborderai pas ici les concepts de la \textit{compilation croisée}. «~La compilation quoi ?!? croisée ?!?~». Bon, le plus simple c'est d'aller sur \href{https://fr.wikipedia.org/wiki/Compilateur#Compilation_crois.C3.A9e}{Wikipédia}. En gros, on compile quelque chose pour une architecture\footnote{Par architecture, comprenez processeur.}  cible autre que celle sur laquelle on est entrain de compiler. Vous y êtes toujours pas ?!? Plus simplement, on compile quelque chose sur notre PC \textit{Intel} (\textit{x86}) destiné à être utiliser sur notre \textit{Raspberry-PI} flambant neuf (\textit{ARM}). C'est bon vous y êtes ?!? Avec un exemple c'est toujours plus facile à comprendre...\\

Nous allons simplement compiler un noyau pour l'architecture (la machine) sur laquelle vous travaillez actuellement. Nous émulerons le noyau par la suite avec \textit{QEMU}.\\

Allons sur le site \href{http://www.kernel.org}{kernel.org} pout télécharger la dernière version stable du noyau\footnote{A l'heure où j'écris ces lignes, la dernière version stable du noyau est la version 4.3.}. La figure~\ref{makefile:linux_download} montre une règle \textit{Makefile} permettant d'automatiser le téléchargement et le désarchivage de la dernière version stable du noyau. Vous pouvez la réutiliser en faisant un copier/coller dans un fichier \textit{Makefile} et ensuite executer la commande suivante : \lstset{language=sh}\lstinline{make linux_download}.\\

\begin{figure}
\label{make:linux_download}
\begin{verbatim}
$ make linux_download 
wget -qO- https://www.kernel.org/index.html | sed -n '/<td id="latest_link"/,/<\/td>/s,.*<a.*href="\(.*\)">\(.*\)</a>.*,wget -qO- \1 | tar xvJ \&\& ln -sf linux-\2 linux,p' | sh
linux-4.3/
linux-4.3/.get_maintainer.ignore
linux-4.3/.gitignore
linux-4.3/.mailmap
(...)
linux-4.3/virt/kvm/kvm_main.c
linux-4.3/virt/kvm/vfio.c
linux-4.3/virt/kvm/vfio.h
\end{verbatim}
\caption{Makefile : une règle toute faite pour télécharger et extraire la dernière version stable du noyau Linux.}
\end{figure}

Pour le reste de ce tutoriel, nous supposons que les fichiers sources sont dans le repertoire \textbf{./linux}.\\

Nous y voilà, nous somme fin prêt pour compiler notre premier noyau, exitez non ? Allez, on est parti. Ouvrez un terminal si ce n'est pas déjà fait et : \lstset{language=sh}\lstinline{cd linux && make}... et...

%\begin{figure}
%\label{shell:first_make}
\begin{verbatim}
$ cd linux
$ make
(...)
\end{verbatim}
%\caption{make : première tentative...}
%\end{figure}

C'était trop beau pour être vrai... compiler son noyau n'est pas aussi simple ! Linux est une noyau \textit{monolithyque} \textit{modulaire} qui supporte plusieurs \textit{plateformes} (promis, je ne voulais pas offenser). Comprenez simplement que le projet a besoin d'être configuré pour pouvoir être compilé avec un vulgaire \lstset{language=sh}\lstinline{make}.\\

Linux utilise le language \textit{\href{https://www.kernel.org/doc/Documentation/kbuild/kconfig-language.txt}{Kconfig}} pour décrire les options de configurations : ce sont les fichiers \textbf{Kconfig} présent un peu partout dans les sources.\\

Il existe plusieurs \textit{front-ends} (ou interfaces) pour afficher le menu de configuration du noyau. Généralement, les développeurs utilisent la vielle interface en \textit{ncurses} que l'on appel via \lstset{language=sh}\lstinline{make menuconfig}.\\

On aura remarqué le message suivant lorsque la première commande \lstset{language=sh}\lstinline{make} a échouée :
\begin{verbatim}
***
*** Configuration file ".config" not found!
***
*** Please run some configurator (e.g. "make oldconfig" or
*** "make menuconfig" or "make xconfig").
***
\end{verbatim}
Le fichier \textbf{.config}, qui contient la configuration du noyau, est manquant ! Bien entendu, les sources du noyau viennent sans aucune configuration. Il va donc falloir généré cette configuration.\\

Ce fichier est une simple définition des options qui seront compilés ou non, soit intégré à l'image du noyau soit disponible dans une module.
\begin{verbatim}
# Un commentaire commence par un '#' (cette ligne est donc un commentaire).
#
# Une option est prefixée par 'CONFIG_'. Une option peut prendre peut prendre les 3 valeurs ci-dessous:
# - y pour yes : compilé et intégré dans le noyau
# - m pour module : compilé et peut être chargé (déchargé) via insmod/modprobe (rmmod)
# - # CONFIG_xxx is not set (ou n) : 
CONFIG_xxx=y
CONFIG_xxx=m
# CONFIG_xxx is not set

# booléen
CONFIG_xxx = y
# CONFIG_xxx is not set

# string
CONFIG_xxx = "une simple chaine de caractères"

# integer
CONFIG_xxx = 123
\end{verbatim}

Allez on se fait une petite frailleur ?!?
\begin{verbatim}
$ make menuconfig
ou
$ make tinyconfig
\end{verbatim}

\begin{figure}
\begin{verbatim}
$ make
  HOSTCC  scripts/basic/fixdep
  HOSTCC  scripts/kconfig/conf.o
  SHIPPED scripts/kconfig/zconf.tab.c
  SHIPPED scripts/kconfig/zconf.lex.c
  SHIPPED scripts/kconfig/zconf.hash.c
  HOSTCC  scripts/kconfig/zconf.tab.o
  HOSTLD  scripts/kconfig/conf
scripts/kconfig/conf  --silentoldconfig Kconfig
***
*** Configuration file ".config" not found!
***
*** Please run some configurator (e.g. "make oldconfig" or
*** "make menuconfig" or "make xconfig").
***
scripts/kconfig/Makefile:37: recipe for target 'silentoldconfig' failed
make[2]: *** [silentoldconfig] Error 1
Makefile:531: recipe for target 'silentoldconfig' failed
make[1]: *** [silentoldconfig] Error 2
  SYSTBL  arch/x86/entry/syscalls/../../include/generated/asm/syscalls_32.h
  SYSHDR  arch/x86/entry/syscalls/../../include/generated/uapi/asm/unistd_32.h
  SYSHDR  arch/x86/entry/syscalls/../../include/generated/uapi/asm/unistd_64.h
  SYSHDR  arch/x86/entry/syscalls/../../include/generated/uapi/asm/unistd_x32.h
  HOSTCC  arch/x86/tools/relocs_32.o
  HOSTCC  arch/x86/tools/relocs_64.o
  HOSTCC  arch/x86/tools/relocs_common.o
  HOSTLD  arch/x86/tools/relocs
make: *** No rule to make target 'include/config/auto.conf', needed by 'include/config/kernel.release'.  Stop.
\end{verbatim}
\caption{make - oops}
\end{figure}

\clearpage
\appendix

\section{Contributions}

\clearpage
\listoffigures

\clearpage
\listoftables

\end{document}
